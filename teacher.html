<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>教师主页</title>
  <!-- 引入 SheetJS 用于解析 Excel/CSV -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
    }
    .container {
      display: flex;
      min-height: 100vh;
    }
    .sidebar {
      width: 250px;
      background: #2c3e50;
      color: white;
      padding: 20px 0;
    }
    .sidebar h3 {
      padding: 0 20px;
      margin-bottom: 20px;
    }
    .sidebar button {
      display: block;
      width: 100%;
      padding: 12px 20px;
      margin: 8px 0;
      border: none;
      background: #34495e;
      color: white;
      text-align: left;
      cursor: pointer;
      font-size: 16px;
    }
    .sidebar button:hover {
      background: #3d566e;
    }
    .sidebar button.active {
      background: #3498db;
    }
    .main {
      flex: 1;
      padding: 20px;
    }
    .section {
      display: none;
    }
    .section.active {
      display: block;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    .actions button {
      margin-right: 5px;
      padding: 5px 10px;
      font-size: 14px;
    }
    .edit-input {
      width: 60px;
      padding: 5px;
    }
    .course-item {
      cursor: pointer;
      padding: 10px;
      border-bottom: 1px solid #4a5f7a;
    }
    .course-item:hover {
      background: #3d566e;
    }
    .course-item.active {
      background: #3498db;
    }
    .course-detail-header {
      margin: 20px 0;
      padding-bottom: 10px;
      border-bottom: 2px solid #3498db;
    }

    /* 表单样式优化 */
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 4px;
      font-weight: bold;
    }
    .form-group input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .form-submit-btn {
      padding: 10px 20px;
      background: #2196F3;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    .form-submit-btn:hover {
      background: #1976D2;
    }
    #singleGradeResult, #bulkGradeResult {
      margin-top: 10px;
      min-height: 24px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <div style="padding: 15px; text-align: center; border-bottom: 1px solid #3d566e;">
        <div>欢迎</div>
        <div><strong><span id="name"></span></strong></div>
      </div>
      <h3>教师功能</h3>
      <button id="btn-courses" class="active">课程列表</button>
      <button id="btn-upload">成绩录入</button>
      <button id="btn-info">信息管理</button>
      <button onclick="logout()">退出登录</button>
    </div>

    <div class="main">
      <!-- 课程列表主视图 -->
      <div id="section-courses" class="section active">
        <h2>我的课程</h2>
        <div id="courses-list"></div>
        <div id="course-detail" style="display:none;">
          <div class="course-detail-header">
            <h3 id="detail-title"></h3>
            <button onclick="backToCourseList()">← 返回课程列表</button>
          </div>
          <table id="grades-table">
            <thead>
              <tr>
                <th>学号</th>
                <th>姓名</th>
                <th>分数</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="grades-body"></tbody>
          </table>
        </div>
      </div>

      <!-- 成绩录入 -->
      <div id="section-upload" class="section">
        <!-- 单个录入 -->
        <h2>录入单个学生成绩</h2>
        <form id="singleGradeForm" style="max-width: 500px;">
          <div class="form-group">
            <label for="studentId">学号（必填）</label>
            <input type="text" id="studentId" placeholder="例如：S001" required>
          </div>
          <div class="form-group">
            <label for="studentName">学生姓名（可选）</label>
            <input type="text" id="studentName" placeholder="例如：张三">
          </div>
          <div class="form-group">
            <label for="courseName">课程名称（必填）</label>
            <input type="text" id="courseName" placeholder="例如：数学" required>
          </div>
          <div class="form-group">
            <label for="semester">学期（必填）</label>
            <input type="text" id="semester" placeholder="例如：2024-秋" required>
          </div>
          <div class="form-group">
            <label for="score">分数（0–100，必填）</label>
            <input type="number" id="score" min="0" max="100" step="0.1" placeholder="例如：90" required>
          </div>
          <button type="submit" class="form-submit-btn">保存成绩</button>
          <div id="singleGradeResult"></div>
        </form>

        <!-- 批量录入 -->
        <h2 style="margin-top: 40px;">批量录入成绩（Excel/CSV）</h2>
        <div style="max-width: 500px; margin-top: 15px;">
          <p>请上传包含以下列的 Excel (.xlsx) 或 CSV 文件：</p>
          <ul>
            <li><strong>学号</strong>（必填）</li>
            <li><strong>姓名</strong>（可选）</li>
            <li><strong>分数</strong>（必填，0–100）</li>
          </ul>
          <p>系统将自动使用当前教师所授的<strong>课程名称</strong>和<strong>学期</strong>（需手动填写）。</p>

          <div class="form-group">
            <label for="bulkCourseName">课程名称（必填）</label>
            <input type="text" id="bulkCourseName" placeholder="例如：数学" required>
          </div>
          <div class="form-group">
            <label for="bulkSemester">学期（必填）</label>
            <input type="text" id="bulkSemester" placeholder="例如：2024-秋" required>
          </div>
          <div class="form-group">
            <label for="gradeFile">选择文件（.xlsx, .xls, .csv）</label>
            <input type="file" id="gradeFile" accept=".xlsx,.xls,.csv">
          </div>
          <button type="button" class="form-submit-btn" onclick="uploadGradeFile()">上传并解析</button>
          <div id="bulkGradeResult"></div>
        </div>
      </div>

      <!-- 信息管理 -->
      <div id="section-info" class="section">
        <h2>信息管理</h2>
        <p>功能开发中...</p>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'https://b9vwa2nxmd.execute-api.us-east-1.amazonaws.com/beg';
    const user = JSON.parse(localStorage.getItem('user'));

    if (!user || user.role !== 'teacher') {
      alert('请先登录！');
      location.href = 'index.html';
    }

    document.getElementById('name').textContent = user.name;

    // 导航切换
    function showSection(id) {
      document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.sidebar button').forEach(btn => btn.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.getElementById('btn-' + id.split('-')[1]).classList.add('active');
    }

    document.getElementById('btn-courses').onclick = () => showSection('section-courses');
    document.getElementById('btn-upload').onclick = () => showSection('section-upload');
    document.getElementById('btn-info').onclick = () => showSection('section-info');

    function logout() {
      localStorage.removeItem('user');
      location.href = 'index.html';
    }

    // ========================
    // 单个成绩录入逻辑
    // ========================
    document.getElementById('singleGradeForm').addEventListener('submit', async function(event) {
      event.preventDefault();
      const resultDiv = document.getElementById('singleGradeResult');
      resultDiv.innerHTML = '';

      const studentId = document.getElementById('studentId').value.trim();
      const studentName = document.getElementById('studentName').value.trim() || '';
      const courseName = document.getElementById('courseName').value.trim();
      const semester = document.getElementById('semester').value.trim();
      const score = parseFloat(document.getElementById('score').value);

      if (!studentId) {
        resultDiv.innerHTML = '<span style="color: red;">请输入学号</span>';
        return;
      }
      if (!courseName) {
        resultDiv.innerHTML = '<span style="color: red;">请输入课程名称</span>';
        return;
      }
      if (!semester) {
        resultDiv.innerHTML = '<span style="color: red;">请输入学期</span>';
        return;
      }
      if (isNaN(score) || score < 0 || score > 100) {
        resultDiv.innerHTML = '<span style="color: red;">分数必须是 0 到 100 之间的数字</span>';
        return;
      }

      const payload = {
        type: 'single',
        data: {
          student_id: studentId,
          student_name: studentName,
          course_name: courseName,
          semester: semester,
          score: score
        }
      };

      try {
        resultDiv.innerHTML = '<span style="color: blue;">正在保存...</span>';
        const response = await fetch(`${API_BASE}/teacher/upload_grades`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-User-ID': user.id
          },
          body: JSON.stringify(payload)
        });
        const result = await response.json();
        if (result.success) {
          resultDiv.innerHTML = '<span style="color: green;">✅ 成绩保存成功！</span>';
          document.getElementById('singleGradeForm').reset();
        } else {
          resultDiv.innerHTML = `<span style="color: red;">❌ 保存失败：${result.message || '未知错误'}</span>`;
        }
      } catch (err) {
        console.error('提交失败:', err);
        resultDiv.innerHTML = '<span style="color: red;">❌ 网络错误，请重试</span>';
      }
    });

    // ========================
    // 批量成绩上传逻辑
    // ========================
    async function uploadGradeFile() {
      const fileInput = document.getElementById('gradeFile');
      const courseName = document.getElementById('bulkCourseName').value.trim();
      const semester = document.getElementById('bulkSemester').value.trim();
      const resultDiv = document.getElementById('bulkGradeResult');

      resultDiv.innerHTML = '';

      if (!courseName) {
        resultDiv.innerHTML = '<span style="color: red;">请输入课程名称</span>';
        return;
      }
      if (!semester) {
        resultDiv.innerHTML = '<span style="color: red;">请输入学期</span>';
        return;
      }
      if (!fileInput.files[0]) {
        resultDiv.innerHTML = '<span style="color: red;">请选择一个文件</span>';
        return;
      }

      const file = fileInput.files[0];
      const ext = file.name.split('.').pop().toLowerCase();
      if (!['xlsx', 'xls', 'csv'].includes(ext)) {
        resultDiv.innerHTML = '<span style="color: red;">仅支持 .xlsx、.xls 或 .csv 文件</span>';
        return;
      }

      try {
        resultDiv.innerHTML = '<span style="color: blue;">正在解析文件...</span>';
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

        if (jsonData.length < 2) {
          resultDiv.innerHTML = '<span style="color: red;">文件为空或格式不正确</span>';
          return;
        }

        const headers = jsonData[0].map(h => (h || '').toString().trim());
        const rows = jsonData.slice(1);

        const studentIdCol = headers.findIndex(h => /学号|student[_\s]?id/i.test(h));
        const nameCol = headers.findIndex(h => /姓名|name/i.test(h));
        const scoreCol = headers.findIndex(h => /分数|score|grade/i.test(h));

        if (studentIdCol === -1 || scoreCol === -1) {
          resultDiv.innerHTML = '<span style="color: red;">文件缺少“学号”或“分数”列</span>';
          return;
        }

        const records = [];
        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          if (!row || row.length === 0) continue;

          const studentId = (row[studentIdCol] || '').toString().trim();
          if (!studentId) continue;

          const studentName = nameCol !== -1 ? (row[nameCol] || '').toString().trim() : '';
          let score = row[scoreCol];

          if (typeof score === 'string') score = parseFloat(score.replace(/[%％]/g, ''));
          if (typeof score !== 'number' || isNaN(score)) {
            resultDiv.innerHTML = `<span style="color: red;">第 ${i + 2} 行：分数格式错误（"${row[scoreCol]}"）</span>`;
            return;
          }
          if (score < 0 || score > 100) {
            resultDiv.innerHTML = `<span style="color: red;">第 ${i + 2} 行：分数必须在 0–100 之间</span>`;
            return;
          }

          records.push({
            student_id: studentId,
            student_name: studentName,
            course_name: courseName,
            semester: semester,
            score: parseFloat(score.toFixed(1))
          });
        }

        if (records.length === 0) {
          resultDiv.innerHTML = '<span style="color: red;">未找到有效成绩数据</span>';
          return;
        }

        resultDiv.innerHTML = `<span style="color: blue;">正在上传 ${records.length} 条成绩...</span>`;

        const payload = {
          type: 'batch',
          data: records
        };

        const response = await fetch(`${API_BASE}/teacher/upload_grades`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-User-ID': user.id
          },
          body: JSON.stringify(payload)
        });

        const result = await response.json();
        if (result.success) {
          resultDiv.innerHTML = `<span style="color: green;">✅ 成功上传 ${records.length} 条成绩！</span>`;
          document.getElementById('gradeFile').value = '';
          document.getElementById('bulkCourseName').value = '';
          document.getElementById('bulkSemester').value = '';
        } else {
          resultDiv.innerHTML = `<span style="color: red;">❌ 上传失败：${result.message || '未知错误'}</span>`;
        }

      } catch (err) {
        console.error('文件解析失败:', err);
        resultDiv.innerHTML = `<span style="color: red;">❌ 文件解析错误：${err.message}</span>`;
      }
    }

    // ========================
    // 课程列表与成绩管理逻辑
    // ========================
    let currentCourse = null;

    async function loadCourses() {
      try {
        const res = await fetch(`${API_BASE}/teacher/grades`, {
          headers: { 'X-User-ID': user.id }
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.message || '加载失败');

        const list = document.getElementById('courses-list');
        list.innerHTML = data.data.map(course => `
          <div class="course-item" onclick="loadCourseGrades('${course.course_name}', '${course.semester}')">
            <strong>${course.course_name}</strong><br>
            学期: ${course.semester} | 学生: ${course.student_count}人
          </div>
        `).join('');
      } catch (err) {
        alert('加载课程失败: ' + err.message);
        console.error(err);
      }
    }

    async function loadCourseGrades(course, semester) {
      currentCourse = { course, semester };
      try {
        const encodedCourse = encodeURIComponent(course);
        const encodedSemester = encodeURIComponent(semester);
        const url = `${API_BASE}/teacher/grades?course=${encodedCourse}&semester=${encodedSemester}`;
        
        const res = await fetch(url, {
          headers: { 'X-User-ID': user.id }
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.message || '加载成绩失败');

        document.getElementById('detail-title').innerText = `${course} - ${semester}`;
        const tbody = document.getElementById('grades-body');
        tbody.innerHTML = data.data.map(record => `
          <tr data-id="${record.student_id}_${record.course_semester}">
            <td>${record.student_id}</td>
            <td>${record.student_name}</td>
            <td class="score-cell" data-score="${record.score}">
              <span class="score-text">${record.score}</span>
              <input type="number" class="edit-input" value="${record.score}" min="0" max="100" style="display:none;">
            </td>
            <td class="actions">
              <button onclick="toggleEdit(this, '${record.student_id}', '${record.course_semester}')">编辑</button>
              <button onclick="deleteRecord('${record.student_id}', '${record.course_semester}')">删除</button>
            </td>
          </tr>
        `).join('');

        document.getElementById('courses-list').style.display = 'none';
        document.getElementById('course-detail').style.display = 'block';
      } catch (err) {
        alert('加载成绩失败: ' + err.message);
        console.error(err);
      }
    }

    function backToCourseList() {
      document.getElementById('courses-list').style.display = 'block';
      document.getElementById('course-detail').style.display = 'none';
      currentCourse = null;
    }

    function toggleEdit(btn, studentId, courseSemester) {
      const row = btn.closest('tr');
      const scoreCell = row.querySelector('.score-cell');
      const text = scoreCell.querySelector('.score-text');
      const input = scoreCell.querySelector('.edit-input');

      if (btn.innerText === '编辑') {
        text.style.display = 'none';
        input.style.display = 'inline';
        btn.innerText = '保存';
      } else {
        const newScore = parseFloat(input.value);
        if (isNaN(newScore) || newScore < 0 || newScore > 100) {
          alert('分数必须是 0-100 的数字');
          return;
        }

        updateRecord(studentId, courseSemester, newScore)
          .then(() => {
            text.innerText = newScore;
            text.style.display = 'inline';
            input.style.display = 'none';
            btn.innerText = '编辑';
            scoreCell.dataset.score = newScore;
          })
          .catch(err => {
            alert('保存失败: ' + err.message);
          });
      }
    }

    async function updateRecord(studentId, courseSemester, score) {
      const res = await fetch(`${API_BASE}/teacher/grades`, {
        method: 'PUT',
        headers: {
          'X-User-ID': user.id,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ student_id: studentId, course_semester: courseSemester, score })
      });
      const data = await res.json();
      if (!data.success) throw new Error(data.message);
    }

    async function deleteRecord(studentId, courseSemester) {
      if (!confirm('确定删除？')) return;
      
      const encodedId = encodeURIComponent(studentId);
      const encodedCS = encodeURIComponent(courseSemester);
      const url = `${API_BASE}/teacher/grades?student_id=${encodedId}&course_semester=${encodedCS}`;
      
      const res = await fetch(url, {
        method: 'DELETE',
        headers: { 'X-User-ID': user.id }
      });
      const data = await res.json();
      if (!data.success) throw new Error(data.message);
      
      document.querySelector(`tr[data-id="${studentId}_${courseSemester}"]`).remove();
    }

    // 初始化
    loadCourses();
  </script>
</body>
</html>
