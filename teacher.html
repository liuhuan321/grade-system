<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>æ•™å¸ˆä¸»é¡µ - æˆç»©ç®¡ç†ç³»ç»Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- å¼•å…¥ SheetJS ç”¨äºè§£æ Excel/CSV -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      --primary-color: #3498db;
      --primary-dark: #2980b9;
      --secondary-color: #2c3e50;
      --accent-color: #2ecc71;
      --light-gray: #f8f9fa;
      --medium-gray: #e9ecef;
      --dark-gray: #6c757d;
      --danger-color: #e74c3c;
      --warning-color: #f39c12;
      --border-radius: 8px;
      --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', 'Microsoft YaHei', Arial, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      color: var(--secondary-color);
      line-height: 1.6;
    }
    
    .container {
      display: flex;
      min-height: 100vh;
    }
    
    /* ä¾§è¾¹æ æ ·å¼ */
    .sidebar {
      width: 280px;
      background: var(--secondary-color);
      color: white;
      padding: 0;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }
    
    .user-info {
      padding: 25px 20px;
      text-align: center;
      background: rgba(0, 0, 0, 0.2);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .user-info .welcome {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.8);
      margin-bottom: 5px;
    }
    
    .user-info .name {
      font-size: 18px;
      font-weight: 600;
    }
    
    .sidebar h3 {
      padding: 20px;
      margin-bottom: 0;
      font-size: 16px;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.7);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .sidebar button {
      display: flex;
      align-items: center;
      width: 100%;
      padding: 14px 20px;
      margin: 0;
      border: none;
      background: transparent;
      color: rgba(255, 255, 255, 0.8);
      text-align: left;
      cursor: pointer;
      font-size: 15px;
      transition: var(--transition);
      border-left: 3px solid transparent;
    }
    
    .sidebar button:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }
    
    .sidebar button.active {
      background: rgba(255, 255, 255, 0.15);
      color: white;
      border-left-color: var(--primary-color);
    }
    
    .sidebar button i {
      margin-right: 12px;
      font-size: 18px;
    }
    
    .btn-logout {
      margin-top: 20px;
      background: rgba(231, 76, 60, 0.2) !important;
      color: rgba(255, 255, 255, 0.9) !important;
    }
    
    .btn-logout:hover {
      background: rgba(231, 76, 60, 0.3) !important;
    }
    
    /* ä¸»å†…å®¹åŒºæ ·å¼ */
    .main {
      flex: 1;
      padding: 25px;
      overflow-y: auto;
    }
    
    .section {
      display: none;
      animation: fadeIn 0.5s ease;
    }
    
    .section.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* å¡ç‰‡æ ·å¼ */
    .card {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 25px;
      margin-bottom: 25px;
      transition: var(--transition);
    }
    
    .card:hover {
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
    }
    
    .card h2 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--secondary-color);
      display: flex;
      align-items: center;
    }
    
    .card h2:before {
      margin-right: 10px;
      font-size: 26px;
    }
    
    /* è¯¾ç¨‹åˆ—è¡¨æ ·å¼ */
    .course-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .course-card {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 20px;
      transition: var(--transition);
      cursor: pointer;
      border-left: 4px solid var(--primary-color);
    }
    
    .course-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }
    
    .course-card h3 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--secondary-color);
    }
    
    .course-card p {
      color: var(--dark-gray);
      font-size: 14px;
    }
    
    /* è¡¨æ ¼æ ·å¼ */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    thead {
      background: var(--light-gray);
    }
    
    th {
      padding: 15px;
      text-align: left;
      font-weight: 600;
      color: var(--secondary-color);
      border-bottom: 2px solid var(--medium-gray);
    }
    
    td {
      padding: 15px;
      border-bottom: 1px solid var(--medium-gray);
    }
    
    tbody tr {
      transition: var(--transition);
    }
    
    tbody tr:hover {
      background: rgba(52, 152, 219, 0.05);
    }
    
    .actions button {
      margin-right: 5px;
      padding: 6px 12px;
      font-size: 13px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .btn-edit {
      background: var(--primary-color);
      color: white;
    }
    
    .btn-edit:hover {
      background: var(--primary-dark);
    }
    
    .btn-delete {
      background: var(--danger-color);
      color: white;
    }
    
    .btn-delete:hover {
      background: #c0392b;
    }
    
    .edit-input {
      width: 70px;
      padding: 6px;
      border: 1px solid var(--medium-gray);
      border-radius: 4px;
    }
    
    /* è¡¨å•æ ·å¼ */
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--secondary-color);
    }
    
    .form-group input, .form-group select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--medium-gray);
      border-radius: var(--border-radius);
      font-size: 15px;
      transition: var(--transition);
      background-color: var(--light-gray);
    }
    
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: var(--primary-color);
      background-color: white;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    
    .form-submit-btn {
      padding: 12px 25px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .form-submit-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }
    
    .form-submit-btn:active {
      transform: translateY(0);
    }
    
    /* ç»“æœæ¶ˆæ¯æ ·å¼ */
    .result-message {
      margin-top: 15px;
      padding: 12px 15px;
      border-radius: var(--border-radius);
      font-weight: 500;
    }
    
    .result-success {
      background: rgba(46, 204, 113, 0.1);
      color: var(--accent-color);
      border: 1px solid rgba(46, 204, 113, 0.2);
    }
    
    .result-error {
      background: rgba(231, 76, 60, 0.1);
      color: var(--danger-color);
      border: 1px solid rgba(231, 76, 60, 0.2);
    }
    
    .result-info {
      background: rgba(52, 152, 219, 0.1);
      color: var(--primary-color);
      border: 1px solid rgba(52, 152, 219, 0.2);
    }
    
    /* æ—¶é—´æ®µè®¾ç½®æ ·å¼ */
    .time-period-section {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 25px;
      margin-bottom: 25px;
    }
    
    .time-period-section h3 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--secondary-color);
      display: flex;
      align-items: center;
    }
    
    .time-period-section h3:before {
      content: "â°";
      margin-right: 10px;
      font-size: 22px;
    }
    
    .time-display {
      background: var(--light-gray);
      padding: 20px;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
      border: 1px solid var(--medium-gray);
    }
    
    .time-display p {
      margin: 10px 0;
      font-size: 16px;
    }
    
    .time-display strong {
      color: var(--secondary-color);
    }
    
    .edit-time-btn {
      background: var(--accent-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      transition: var(--transition);
    }
    
    .edit-time-btn:hover {
      background: #27ae60;
      transform: translateY(-2px);
    }
    
    .time-form {
      background: var(--light-gray);
      padding: 25px;
      border-radius: var(--border-radius);
      border: 1px solid var(--medium-gray);
    }
    
    .form-actions {
      margin-top: 20px;
      display: flex;
      gap: 10px;
    }
    
    .cancel-btn {
      background: var(--dark-gray);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 15px;
      transition: var(--transition);
    }
    
    .cancel-btn:hover {
      background: #5a6268;
    }
    
    .current-status {
      margin-top: 15px;
      padding: 12px 15px;
      border-radius: var(--border-radius);
      font-weight: 500;
      text-align: center;
    }
    
    .status-active {
      background: rgba(46, 204, 113, 0.1);
      color: var(--accent-color);
      border: 1px solid rgba(46, 204, 113, 0.2);
    }
    
    .status-inactive {
      background: rgba(243, 156, 18, 0.1);
      color: var(--warning-color);
      border: 1px solid rgba(243, 156, 18, 0.2);
    }
    
    .status-error {
      background: rgba(231, 76, 60, 0.1);
      color: var(--danger-color);
      border: 1px solid rgba(231, 76, 60, 0.2);
    }
    
    /* æ–‡ä»¶ä¸Šä¼ æ ·å¼ */
    .file-upload {
      border: 2px dashed var(--medium-gray);
      border-radius: var(--border-radius);
      padding: 30px;
      text-align: center;
      margin-bottom: 20px;
      transition: var(--transition);
    }
    
    .file-upload:hover {
      border-color: var(--primary-color);
      background: rgba(52, 152, 219, 0.05);
    }
    
    .file-upload p {
      margin-bottom: 15px;
      color: var(--dark-gray);
    }
    
    /* åŠ è½½çŠ¶æ€ */
    .loading {
      text-align: center;
      padding: 30px;
      color: var(--dark-gray);
    }
    
    .loading-spinner {
      display: inline-block;
      width: 30px;
      height: 30px;
      border: 3px solid rgba(52, 152, 219, 0.3);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
      margin-bottom: 15px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 1024px) {
      .container {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        height: auto;
      }
      
      .sidebar-nav {
        display: flex;
        overflow-x: auto;
      }
      
      .sidebar button {
        flex: 1;
        min-width: 120px;
        justify-content: center;
        text-align: center;
        border-left: none;
        border-bottom: 3px solid transparent;
      }
      
      .sidebar button.active {
        border-left: none;
        border-bottom-color: var(--primary-color);
      }
      
      .sidebar button i {
        margin-right: 0;
        margin-bottom: 5px;
        display: block;
      }
    }
    
    @media (max-width: 768px) {
      .main {
        padding: 15px;
      }
      
      .card {
        padding: 20px;
      }
      
      .course-grid {
        grid-template-columns: 1fr;
      }
      
      .form-actions {
        flex-direction: column;
      }
      
      table {
        display: block;
        overflow-x: auto;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <div class="user-info">
        <div class="welcome">æ¬¢è¿</div>
        <div class="name"><span id="name"></span></div>
      </div>
      
      <h3>æ•™å¸ˆåŠŸèƒ½</h3>
      <div class="sidebar-nav">
        <button id="btn-courses" class="active">
          <i>ğŸ“š</i> è¯¾ç¨‹åˆ—è¡¨
        </button>
        <button id="btn-upload">
          <i>ğŸ“</i> æˆç»©å½•å…¥
        </button>
        <button id="btn-students">
          <i>ğŸ‘¥</i> å­¦ç”Ÿç®¡ç†
        </button>
        <button onclick="logout()" class="btn-logout">
          <i>ğŸšª</i> é€€å‡ºç™»å½•
        </button>
      </div>
    </div>

    <div class="main">
      <!-- è¯¾ç¨‹åˆ—è¡¨ä¸»è§†å›¾ -->
      <div id="section-courses" class="section active">
        <div class="card">
          <h2>ğŸ“š æˆ‘çš„è¯¾ç¨‹</h2>
          
          <!-- å­¦ç”Ÿæˆç»©æŸ¥è¯¢æ—¶é—´æ®µè®¾ç½® -->
          <div class="time-period-section">
            <h3>å­¦ç”Ÿæˆç»©æŸ¥è¯¢æ—¶é—´æ®µè®¾ç½®</h3>
            <div id="time-period-display">
              <div class="time-display">
                <p><strong>å½“å‰è®¾ç½®ï¼š</strong></p>
                <p>å¼€å§‹æ—¶é—´ï¼š<span id="current-start-time">--</span></p>
                <p>ç»“æŸæ—¶é—´ï¼š<span id="current-end-time">--</span></p>
                <div id="current-status" class="current-status status-inactive">çŠ¶æ€ï¼šæœªè®¾ç½®</div>
              </div>
              <button class="edit-time-btn" onclick="showTimeForm()">ä¿®æ”¹æ—¶é—´æ®µ</button>
            </div>
            <div id="time-period-form" class="time-form" style="display: none;">
              <h4>è®¾ç½®å­¦ç”ŸæŸ¥è¯¢æ—¶é—´æ®µ</h4>
              <form id="timePeriodForm">
                <div class="form-group">
                  <label for="startTime">å¼€å§‹æ—¶é—´ï¼š</label>
                  <input type="datetime-local" id="startTime" required>
                </div>
                <div class="form-group">
                  <label for="endTime">ç»“æŸæ—¶é—´ï¼š</label>
                  <input type="datetime-local" id="endTime" required>
                </div>
                <div class="form-actions">
                  <button type="submit" class="form-submit-btn">ä¿å­˜è®¾ç½®</button>
                  <button type="button" class="cancel-btn" onclick="hideTimeForm()">å–æ¶ˆ</button>
                </div>
                <div id="timePeriodResult" class="result-message"></div>
              </form>
            </div>
          </div>

          <div id="courses-list" class="course-grid"></div>
          
          <div id="course-detail" style="display:none;">
            <div class="card">
              <h3 id="detail-title"></h3>
              <button class="form-submit-btn" onclick="backToCourseList()">â† è¿”å›è¯¾ç¨‹åˆ—è¡¨</button>
            </div>
            
            <div class="card">
              <table id="grades-table">
                <thead>
                  <tr>
                    <th>å­¦å·</th>
                    <th>å§“å</th>
                    <th>åˆ†æ•°</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="grades-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- æˆç»©å½•å…¥ -->
      <div id="section-upload" class="section">
        <div class="card">
          <h2>ğŸ“ æˆç»©å½•å…¥</h2>
          
          <!-- å•ä¸ªå½•å…¥ -->
          <div class="card" style="margin-bottom: 30px;">
            <h3>å½•å…¥å•ä¸ªå­¦ç”Ÿæˆç»©</h3>
            <form id="singleGradeForm">
              <div class="form-group">
                <label for="studentId">å­¦å·ï¼ˆå¿…å¡«ï¼‰</label>
                <input type="text" id="studentId" placeholder="ä¾‹å¦‚ï¼šS001" required>
              </div>
              <div class="form-group">
                <label for="studentName">å­¦ç”Ÿå§“åï¼ˆå¯é€‰ï¼‰</label>
                <input type="text" id="studentName" placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰">
              </div>
              <div class="form-group">
                <label for="courseName">è¯¾ç¨‹åç§°ï¼ˆå¿…å¡«ï¼‰</label>
                <input type="text" id="courseName" placeholder="ä¾‹å¦‚ï¼šæ•°å­¦" required>
              </div>
              <div class="form-group">
                <label for="semester">å­¦æœŸï¼ˆå¿…å¡«ï¼‰</label>
                <input type="text" id="semester" placeholder="ä¾‹å¦‚ï¼š2024-ç§‹" required>
              </div>
              <div class="form-group">
                <label for="score">åˆ†æ•°ï¼ˆ0â€“100ï¼Œå¿…å¡«ï¼‰</label>
                <input type="number" id="score" min="0" max="100" step="0.1" placeholder="ä¾‹å¦‚ï¼š90" required>
              </div>
              <button type="submit" class="form-submit-btn">ä¿å­˜æˆç»©</button>
              <div id="singleGradeResult" class="result-message"></div>
            </form>
          </div>

          <!-- æ‰¹é‡å½•å…¥ -->
          <div class="card">
            <h3>æ‰¹é‡å½•å…¥æˆç»©ï¼ˆExcel/CSVï¼‰</h3>
            <p>è¯·ä¸Šä¼ åŒ…å«ä»¥ä¸‹åˆ—çš„ Excel (.xlsx) æˆ– CSV æ–‡ä»¶ï¼š</p>
            <ul style="margin: 15px 0; padding-left: 20px;">
              <li><strong>å­¦å·</strong>ï¼ˆå¿…å¡«ï¼‰</li>
              <li><strong>å§“å</strong>ï¼ˆå¯é€‰ï¼‰</li>
              <li><strong>åˆ†æ•°</strong>ï¼ˆå¿…å¡«ï¼Œ0â€“100ï¼‰</li>
            </ul>
            <p>ç³»ç»Ÿå°†è‡ªåŠ¨ä½¿ç”¨å½“å‰æ•™å¸ˆæ‰€æˆçš„<strong>è¯¾ç¨‹åç§°</strong>å’Œ<strong>å­¦æœŸ</strong>ï¼ˆéœ€æ‰‹åŠ¨å¡«å†™ï¼‰ã€‚</p>

            <form>
              <div class="form-group">
                <label for="bulkCourseName">è¯¾ç¨‹åç§°ï¼ˆå¿…å¡«ï¼‰</label>
                <input type="text" id="bulkCourseName" placeholder="ä¾‹å¦‚ï¼šæ•°å­¦" required>
              </div>
              <div class="form-group">
                <label for="bulkSemester">å­¦æœŸï¼ˆå¿…å¡«ï¼‰</label>
                <input type="text" id="bulkSemester" placeholder="ä¾‹å¦‚ï¼š2024-ç§‹" required>
              </div>
              <div class="file-upload">
                <p>å°†æ–‡ä»¶æ‹–æ”¾åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                <input type="file" id="gradeFile" accept=".xlsx,.xls,.csv">
              </div>
              <button type="button" class="form-submit-btn" onclick="uploadGradeFile()">ä¸Šä¼ å¹¶è§£æ</button>
              <div id="bulkGradeResult" class="result-message"></div>
            </form>
          </div>
        </div>
      </div>

      <!-- å­¦ç”Ÿç®¡ç† -->
      <div id="section-students" class="section">
        <div class="card">
          <h2>ğŸ‘¥ å­¦ç”Ÿç®¡ç†</h2>

          <!-- æ·»åŠ å­¦ç”Ÿè¡¨å• -->
          <div class="card" style="margin-bottom: 30px;">
            <h3>æ·»åŠ æ–°å­¦ç”Ÿ</h3>
            <form id="addStudentForm">
              <div class="form-group">
                <label for="newStudentId">å­¦å·ï¼ˆå¿…å¡«ï¼Œæ ¼å¼å¦‚ S001ï¼‰</label>
                <input type="text" id="newStudentId" placeholder="S001" required>
              </div>
              <div class="form-group">
                <label for="newStudentName">å§“åï¼ˆå¿…å¡«ï¼‰</label>
                <input type="text" id="newStudentName" placeholder="å¼ ä¸‰" required>
              </div>
              <div class="form-group">
                <label for="newStudentClass">ç­çº§ï¼ˆå¿…å¡«ï¼‰</label>
                <input type="text" id="newStudentClass" placeholder="è®¡ç®—æœº2201ç­" required>
              </div>
              <button type="submit" class="form-submit-btn">æ·»åŠ å­¦ç”Ÿ</button>
              <div id="addStudentResult" class="result-message"></div>
            </form>
          </div>

          <!-- å­¦ç”Ÿåˆ—è¡¨ -->
          <div class="card">
            <h3>å­¦ç”Ÿåˆ—è¡¨</h3>
            <table id="students-table">
              <thead>
                <tr>
                  <th>å­¦å·</th>
                  <th>å§“å</th>
                  <th>ç­çº§</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="students-body"></tbody>
            </table>
            <div id="students-load-message" class="loading" style="display: none;">
              <div class="loading-spinner"></div>
              <p>åŠ è½½ä¸­...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
    const API_BASE = 'https://b9vwa2nxmd.execute-api.us-east-1.amazonaws.com/beg';
    const user = JSON.parse(localStorage.getItem('user'));

    if (!user || user.role !== 'teacher') {
      alert('è¯·å…ˆç™»å½•ï¼');
      location.href = 'index.html';
    }

    document.getElementById('name').textContent = user.name;

    // å¯¼èˆªåˆ‡æ¢
    function showSection(id) {
      document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.sidebar button').forEach(btn => btn.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      const btnId = 'btn-' + id.split('-')[1];
      if (document.getElementById(btnId)) {
        document.getElementById(btnId).classList.add('active');
      }
    }

    document.getElementById('btn-courses').onclick = () => showSection('section-courses');
    document.getElementById('btn-upload').onclick = () => showSection('section-upload');

    // å­¦ç”Ÿç®¡ç†æŒ‰é’®ç‚¹å‡»æ—¶åŠ è½½æ•°æ®
    document.getElementById('btn-students').onclick = () => {
      showSection('section-students');
      loadStudents();
    };

    function logout() {
      localStorage.removeItem('user');
      location.href = 'index.html';
    }

    // ========================
    // æ—¶é—´æ®µè®¾ç½®é€»è¾‘
    // ========================
    async function loadTimePeriod() {
     try {
    console.log('æ­£åœ¨è·å–æ—¶é—´æ®µè®¾ç½®...');
    console.log('ç”¨æˆ·ID:', user.id);
    
    const res = await fetch(`${API_BASE}/teacher/time`, {
      headers: { 'X-User-ID': user.id }
    });
    
    console.log('å“åº”çŠ¶æ€:', res.status);
    
    if (!res.ok) {
      const errorText = await res.text();
      console.error('å“åº”å†…å®¹:', errorText);
      throw new Error(`HTTP error! status: ${res.status}, response: ${errorText}`);
    }
    
    const data = await res.json();
    console.log('æ—¶é—´æ®µæ•°æ®:', data);
        if (data.success) {
          // æ›´æ–°æ˜¾ç¤º
          const startTime = data.start_time ? new Date(data.start_time).toLocaleString('zh-CN') : 'æœªè®¾ç½®';
          const endTime = data.end_time ? new Date(data.end_time).toLocaleString('zh-CN') : 'æœªè®¾ç½®';
          
          document.getElementById('current-start-time').textContent = startTime;
          document.getElementById('current-end-time').textContent = endTime;
          
          // æ›´æ–°çŠ¶æ€
          const now = new Date();
          const start = data.start_time ? new Date(data.start_time) : null;
          const end = data.end_time ? new Date(data.end_time) : null;
          
          const statusElement = document.getElementById('current-status');
          if (start && end) {
            if (now >= start && now <= end) {
              statusElement.textContent = 'çŠ¶æ€ï¼šå¯æŸ¥è¯¢ï¼ˆå½“å‰åœ¨æ—¶é—´æ®µå†…ï¼‰';
              statusElement.className = 'current-status status-active';
            } else if (now < start) {
              statusElement.textContent = 'çŠ¶æ€ï¼šæœªå¼€å§‹ï¼ˆå°†åœ¨æœªæ¥æ—¶é—´æ®µå†…å¼€æ”¾ï¼‰';
              statusElement.className = 'current-status status-inactive';
            } else {
              statusElement.textContent = 'çŠ¶æ€ï¼šå·²ç»“æŸï¼ˆæ—¶é—´æ®µå·²è¿‡ï¼‰';
              statusElement.className = 'current-status status-inactive';
            }
          } else {
            statusElement.textContent = 'çŠ¶æ€ï¼šæœªè®¾ç½®æ—¶é—´æ®µ';
            statusElement.className = 'current-status status-inactive';
          }
        } else {
          console.error('è·å–æ—¶é—´æ®µå¤±è´¥:', data.message);
        }
      } catch (err) {
        console.error('åŠ è½½æ—¶é—´æ®µå¤±è´¥:', err);
        // å¦‚æœAPIä¸å­˜åœ¨ï¼Œæ˜¾ç¤ºé»˜è®¤ä¿¡æ¯
        document.getElementById('current-start-time').textContent = 'æœªè®¾ç½®';
        document.getElementById('current-end-time').textContent = 'æœªè®¾ç½®';
        document.getElementById('current-status').textContent = 'çŠ¶æ€ï¼šæœªè®¾ç½®æ—¶é—´æ®µ';
        document.getElementById('current-status').className = 'current-status status-inactive';
      }
    }

    function showTimeForm() {
      document.getElementById('time-period-display').style.display = 'none';
      document.getElementById('time-period-form').style.display = 'block';
    }

    function hideTimeForm() {
      document.getElementById('time-period-display').style.display = 'block';
      document.getElementById('time-period-form').style.display = 'none';
      document.getElementById('timePeriodResult').innerHTML = '';
      document.getElementById('timePeriodResult').className = 'result-message';
    }

    document.getElementById('timePeriodForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const resultDiv = document.getElementById('timePeriodResult');
      resultDiv.innerHTML = '';
      resultDiv.className = 'result-message';

      const startTime = document.getElementById('startTime').value;
      const endTime = document.getElementById('endTime').value;

      if (!startTime || !endTime) {
        resultDiv.innerHTML = 'è¯·å¡«å†™å¼€å§‹å’Œç»“æŸæ—¶é—´';
        resultDiv.className = 'result-message result-error';
        return;
      }

      // è½¬æ¢ä¸ºISOæ ¼å¼
      const startISO = new Date(startTime).toISOString();
      const endISO = new Date(endTime).toISOString();

      if (startISO >= endISO) {
        resultDiv.innerHTML = 'ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´';
        resultDiv.className = 'result-message result-error';
        return;
      }

      try {
        resultDiv.innerHTML = 'æ­£åœ¨ä¿å­˜...';
        resultDiv.className = 'result-message result-info';
        
        const res = await fetch(`${API_BASE}/teacher/time`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-User-ID': user.id
          },
          body: JSON.stringify({
            start_time: startISO,
            end_time: endISO
          })
        });
        
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        
        const data = await res.json();
        if (data.success) {
          resultDiv.innerHTML = 'âœ… æ—¶é—´æ®µè®¾ç½®æˆåŠŸï¼';
          resultDiv.className = 'result-message result-success';
          setTimeout(() => {
            hideTimeForm();
            loadTimePeriod(); // åˆ·æ–°æ˜¾ç¤º
          }, 1500);
        } else {
          resultDiv.innerHTML = `âŒ è®¾ç½®å¤±è´¥ï¼š${data.message}`;
          resultDiv.className = 'result-message result-error';
        }
      } catch (err) {
        console.error('è®¾ç½®æ—¶é—´æ®µå¤±è´¥:', err);
        resultDiv.innerHTML = 'âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';
        resultDiv.className = 'result-message result-error';
      }
    });

    // ========================
    // å•ä¸ªæˆç»©å½•å…¥é€»è¾‘
    // ========================
    document.getElementById('singleGradeForm').addEventListener('submit', async function(event) {
      event.preventDefault();
      const resultDiv = document.getElementById('singleGradeResult');
      resultDiv.innerHTML = '';
      resultDiv.className = 'result-message';

      const studentId = document.getElementById('studentId').value.trim();
      const studentName = document.getElementById('studentName').value.trim() || '';
      const courseName = document.getElementById('courseName').value.trim();
      const semester = document.getElementById('semester').value.trim();
      const score = parseFloat(document.getElementById('score').value);

      if (!studentId) {
        resultDiv.innerHTML = 'è¯·è¾“å…¥å­¦å·';
        resultDiv.className = 'result-message result-error';
        return;
      }
      if (!courseName) {
        resultDiv.innerHTML = 'è¯·è¾“å…¥è¯¾ç¨‹åç§°';
        resultDiv.className = 'result-message result-error';
        return;
      }
      if (!semester) {
        resultDiv.innerHTML = 'è¯·è¾“å…¥å­¦æœŸ';
        resultDiv.className = 'result-message result-error';
        return;
      }
      if (isNaN(score) || score < 0 || score > 100) {
        resultDiv.innerHTML = 'åˆ†æ•°å¿…é¡»æ˜¯ 0 åˆ° 100 ä¹‹é—´çš„æ•°å­—';
        resultDiv.className = 'result-message result-error';
        return;
      }

      const payload = {
        type: 'single',
        data: {
          student_id: studentId,
          student_name: studentName,
          course_name: courseName,
          semester: semester,
          score: score
        }
      };

      try {
        resultDiv.innerHTML = 'æ­£åœ¨ä¿å­˜...';
        resultDiv.className = 'result-message result-info';
        const response = await fetch(`${API_BASE}/teacher/upload_grades`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-User-ID': user.id
          },
          body: JSON.stringify(payload)
        });
        const result = await response.json();
        if (result.success) {
          resultDiv.innerHTML = 'âœ… æˆç»©ä¿å­˜æˆåŠŸï¼';
          resultDiv.className = 'result-message result-success';
          document.getElementById('singleGradeForm').reset();
        } else {
          resultDiv.innerHTML = `âŒ ä¿å­˜å¤±è´¥ï¼š${result.message || 'æœªçŸ¥é”™è¯¯'}`;
          resultDiv.className = 'result-message result-error';
        }
      } catch (err) {
        console.error('æäº¤å¤±è´¥:', err);
        resultDiv.innerHTML = 'âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';
        resultDiv.className = 'result-message result-error';
      }
    });

    // ========================
    // æ‰¹é‡æˆç»©ä¸Šä¼ é€»è¾‘
    // ========================
    async function uploadGradeFile() {
      const fileInput = document.getElementById('gradeFile');
      const courseName = document.getElementById('bulkCourseName').value.trim();
      const semester = document.getElementById('bulkSemester').value.trim();
      const resultDiv = document.getElementById('bulkGradeResult');

      resultDiv.innerHTML = '';
      resultDiv.className = 'result-message';

      if (!courseName) {
        resultDiv.innerHTML = 'è¯·è¾“å…¥è¯¾ç¨‹åç§°';
        resultDiv.className = 'result-message result-error';
        return;
      }
      if (!semester) {
        resultDiv.innerHTML = 'è¯·è¾“å…¥å­¦æœŸ';
        resultDiv.className = 'result-message result-error';
        return;
      }
      if (!fileInput.files[0]) {
        resultDiv.innerHTML = 'è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶';
        resultDiv.className = 'result-message result-error';
        return;
      }

      const file = fileInput.files[0];
      const ext = file.name.split('.').pop().toLowerCase();
      if (!['xlsx', 'xls', 'csv'].includes(ext)) {
        resultDiv.innerHTML = 'ä»…æ”¯æŒ .xlsxã€.xls æˆ– .csv æ–‡ä»¶';
        resultDiv.className = 'result-message result-error';
        return;
      }

      try {
        resultDiv.innerHTML = 'æ­£åœ¨è§£ææ–‡ä»¶...';
        resultDiv.className = 'result-message result-info';
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

        if (jsonData.length < 2) {
          resultDiv.innerHTML = 'æ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®';
          resultDiv.className = 'result-message result-error';
          return;
        }

        const headers = jsonData[0].map(h => (h || '').toString().trim());
        const rows = jsonData.slice(1);

        const studentIdCol = headers.findIndex(h => /å­¦å·|student[_\s]?id/i.test(h));
        const nameCol = headers.findIndex(h => /å§“å|name/i.test(h));
        const scoreCol = headers.findIndex(h => /åˆ†æ•°|score|grade/i.test(h));

        if (studentIdCol === -1 || scoreCol === -1) {
          resultDiv.innerHTML = 'æ–‡ä»¶ç¼ºå°‘"å­¦å·"æˆ–"åˆ†æ•°"åˆ—';
          resultDiv.className = 'result-message result-error';
          return;
        }

        const records = [];
        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          if (!row || row.length === 0) continue;

          const studentId = (row[studentIdCol] || '').toString().trim();
          if (!studentId) continue;

          const studentName = nameCol !== -1 ? (row[nameCol] || '').toString().trim() : '';
          let score = row[scoreCol];

          if (typeof score === 'string') score = parseFloat(score.replace(/[%ï¼…]/g, ''));
          if (typeof score !== 'number' || isNaN(score)) {
            resultDiv.innerHTML = `ç¬¬ ${i + 2} è¡Œï¼šåˆ†æ•°æ ¼å¼é”™è¯¯ï¼ˆ"${row[scoreCol]}"ï¼‰`;
            resultDiv.className = 'result-message result-error';
            return;
          }
          if (score < 0 || score > 100) {
            resultDiv.innerHTML = `ç¬¬ ${i + 2} è¡Œï¼šåˆ†æ•°å¿…é¡»åœ¨ 0â€“100 ä¹‹é—´`;
            resultDiv.className = 'result-message result-error';
            return;
          }

          records.push({
            student_id: studentId,
            student_name: studentName,
            course_name: courseName,
            semester: semester,
            score: parseFloat(score.toFixed(1))
          });
        }

        if (records.length === 0) {
          resultDiv.innerHTML = 'æœªæ‰¾åˆ°æœ‰æ•ˆæˆç»©æ•°æ®';
          resultDiv.className = 'result-message result-error';
          return;
        }

        resultDiv.innerHTML = `æ­£åœ¨ä¸Šä¼  ${records.length} æ¡æˆç»©...`;
        resultDiv.className = 'result-message result-info';

        const payload = {
          type: 'bulk',
          data: records
        };

        const response = await fetch(`${API_BASE}/teacher/upload_grades`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-User-ID': user.id
          },
          body: JSON.stringify(payload)
        });

        const result = await response.json();
        if (result.success) {
          resultDiv.innerHTML = `âœ… æˆåŠŸä¸Šä¼  ${records.length} æ¡æˆç»©ï¼`;
          resultDiv.className = 'result-message result-success';
          document.getElementById('gradeFile').value = '';
          document.getElementById('bulkCourseName').value = '';
          document.getElementById('bulkSemester').value = '';
        } else {
          resultDiv.innerHTML = `âŒ ä¸Šä¼ å¤±è´¥ï¼š${result.message || 'æœªçŸ¥é”™è¯¯'}`;
          resultDiv.className = 'result-message result-error';
        }

      } catch (err) {
        console.error('æ–‡ä»¶è§£æå¤±è´¥:', err);
        resultDiv.innerHTML = `âŒ æ–‡ä»¶è§£æé”™è¯¯ï¼š${err.message}`;
        resultDiv.className = 'result-message result-error';
      }
    }

    // ========================
    // è¯¾ç¨‹åˆ—è¡¨ä¸æˆç»©ç®¡ç†é€»è¾‘
    // ========================
    let currentCourse = null;

    async function loadCourses() {
      try {
        const res = await fetch(`${API_BASE}/teacher/grades`, {
          headers: { 'X-User-ID': user.id }
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.message || 'åŠ è½½å¤±è´¥');

        const list = document.getElementById('courses-list');
        list.innerHTML = data.data.map(course => `
          <div class="course-card" onclick="loadCourseGrades('${course.course_name}', '${course.semester}')">
            <h3>${course.course_name}</h3>
            <p>å­¦æœŸ: ${course.semester} | å­¦ç”Ÿ: ${course.student_count}äºº</p>
          </div>
        `).join('');
      } catch (err) {
        alert('åŠ è½½è¯¾ç¨‹å¤±è´¥: ' + err.message);
        console.error(err);
      }
    }

    async function loadCourseGrades(course, semester) {
      currentCourse = { course, semester };
      try {
        const encodedCourse = encodeURIComponent(course);
        const encodedSemester = encodeURIComponent(semester);
        const url = `${API_BASE}/teacher/grades?course=${encodedCourse}&semester=${encodedSemester}`;
        
        const res = await fetch(url, {
          headers: { 'X-User-ID': user.id }
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.message || 'åŠ è½½æˆç»©å¤±è´¥');

        document.getElementById('detail-title').innerText = `${course} - ${semester}`;
        const tbody = document.getElementById('grades-body');
        tbody.innerHTML = data.data.map(record => `
          <tr data-id="${record.student_id}_${record.course_semester}">
            <td>${record.student_id}</td>
            <td>${record.student_name}</td>
            <td class="score-cell" data-score="${record.score}">
              <span class="score-text">${record.score}</span>
              <input type="number" class="edit-input" value="${record.score}" min="0" max="100" style="display:none;">
            </td>
            <td class="actions">
              <button class="btn-edit" onclick="toggleEdit(this, '${record.student_id}', '${record.course_semester}')">ç¼–è¾‘</button>
              <button class="btn-delete" onclick="deleteRecord('${record.student_id}', '${record.course_semester}')">åˆ é™¤</button>
            </td>
          </tr>
        `).join('');

        document.getElementById('courses-list').style.display = 'none';
        document.getElementById('course-detail').style.display = 'block';
      } catch (err) {
        alert('åŠ è½½æˆç»©å¤±è´¥: ' + err.message);
        console.error(err);
      }
    }

    function backToCourseList() {
      document.getElementById('courses-list').style.display = 'block';
      document.getElementById('course-detail').style.display = 'none';
      currentCourse = null;
    }

    function toggleEdit(btn, studentId, courseSemester) {
      const row = btn.closest('tr');
      const scoreCell = row.querySelector('.score-cell');
      const text = scoreCell.querySelector('.score-text');
      const input = scoreCell.querySelector('.edit-input');

      if (btn.innerText === 'ç¼–è¾‘') {
        text.style.display = 'none';
        input.style.display = 'inline';
        btn.innerText = 'ä¿å­˜';
        btn.className = 'btn-edit';
      } else {
        const newScore = parseFloat(input.value);
        if (isNaN(newScore) || newScore < 0 || newScore > 100) {
          alert('åˆ†æ•°å¿…é¡»æ˜¯ 0-100 çš„æ•°å­—');
          return;
        }

        updateRecord(studentId, courseSemester, newScore)
          .then(() => {
            text.innerText = newScore;
            text.style.display = 'inline';
            input.style.display = 'none';
            btn.innerText = 'ç¼–è¾‘';
            btn.className = 'btn-edit';
            scoreCell.dataset.score = newScore;
          })
          .catch(err => {
            alert('ä¿å­˜å¤±è´¥: ' + err.message);
          });
      }
    }

    async function updateRecord(studentId, courseSemester, score) {
      const res = await fetch(`${API_BASE}/teacher/grades`, {
        method: 'PUT',
        headers: {
          'X-User-ID': user.id,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ student_id: studentId, course_semester: courseSemester, score })
      });
      const data = await res.json();
      if (!data.success) throw new Error(data.message);
    }

    async function deleteRecord(studentId, courseSemester) {
      if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
      
      const encodedId = encodeURIComponent(studentId);
      const encodedCS = encodeURIComponent(courseSemester);
      const url = `${API_BASE}/teacher/grades?student_id=${encodedId}&course_semester=${encodedCS}`;
      
      const res = await fetch(url, {
        method: 'DELETE',
        headers: { 'X-User-ID': user.id }
      });
      const data = await res.json();
      if (!data.success) throw new Error(data.message);
      
      document.querySelector(`tr[data-id="${studentId}_${courseSemester}"]`).remove();
    }

    // ========================
    // å­¦ç”Ÿç®¡ç†é€»è¾‘
    // ========================
    async function loadStudents() {
      const tbody = document.getElementById('students-body');
      const msg = document.getElementById('students-load-message');
      try {
        msg.style.display = 'block';
        const res = await fetch(`${API_BASE}/teacher/students`, {
          headers: { 'X-User-ID': user.id }
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.message || 'åŠ è½½å¤±è´¥');

        const students = data.students || [];
        if (students.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">æš‚æ— å­¦ç”Ÿ</td></tr>';
          msg.style.display = 'none';
          return;
        }

        tbody.innerHTML = students.map(s => `
          <tr data-id="${s.id}">
            <td>${s.id}</td>
            <td class="name-cell" data-name="${s.name}">${s.name}</td>
            <td class="class-cell" data-class="${s.class}">${s.class}</td>
            <td class="actions">
              <button class="btn-edit" onclick="editStudent('${s.id}', this)">ç¼–è¾‘</button>
              <button class="btn-delete" onclick="deleteStudent('${s.id}')">åˆ é™¤</button>
            </td>
          </tr>
        `).join('');
        msg.style.display = 'none';
      } catch (err) {
        console.error('åŠ è½½å­¦ç”Ÿå¤±è´¥:', err);
        msg.innerHTML = '<div class="result-message result-error">âŒ åŠ è½½å¤±è´¥ï¼š' + err.message + '</div>';
      }
    }

   document.getElementById('addStudentForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const resultDiv = document.getElementById('addStudentResult');
  resultDiv.innerHTML = '';
  resultDiv.className = 'result-message';

  const id = document.getElementById('newStudentId').value.trim();
  const name = document.getElementById('newStudentName').value.trim();
  const cls = document.getElementById('newStudentClass').value.trim();

  if (!id || !name || !cls) {
    resultDiv.innerHTML = 'è¯·å¡«å†™æ‰€æœ‰å­—æ®µ';
    resultDiv.className = 'result-message result-error';
    return;
  }
  if (!id.startsWith('S') || !/^\d+$/.test(id.slice(1))) {
    resultDiv.innerHTML = 'å­¦å·æ ¼å¼åº”ä¸º S+æ•°å­—ï¼ˆå¦‚ S001ï¼‰';
    resultDiv.className = 'result-message result-error';
    return;
  }

  try {
    resultDiv.innerHTML = 'æ­£åœ¨æ·»åŠ ...';
    resultDiv.className = 'result-message result-info';
    
    // è°ƒè¯•ä¿¡æ¯
    console.log('å‘é€è¯·æ±‚å¤´ X-User-ID:', user.id);
    
    const res = await fetch(`${API_BASE}/teacher/students`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-User-ID': user.id
      },
      body: JSON.stringify({ id, name, class: cls })
    });
    
    // æ£€æŸ¥å“åº”çŠ¶æ€
    console.log('å“åº”çŠ¶æ€:', res.status);
    const data = await res.json();
    console.log('å“åº”æ•°æ®:', data);
    
    if (data.success) {
      resultDiv.innerHTML = 'âœ… æ·»åŠ æˆåŠŸï¼';
      resultDiv.className = 'result-message result-success';
      document.getElementById('addStudentForm').reset();
      loadStudents();
    } else {
      resultDiv.innerHTML = `âŒ ${data.message}`;
      resultDiv.className = 'result-message result-error';
    }
  } catch (err) {
    console.error('æ·»åŠ å­¦ç”Ÿå¤±è´¥:', err);
    resultDiv.innerHTML = 'âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°';
    resultDiv.className = 'result-message result-error';
  }
});

    function editStudent(studentId, btn) {
      const row = btn.closest('tr');
      const nameCell = row.querySelector('.name-cell');
      const classCell = row.querySelector('.class-cell');

      const currentName = nameCell.dataset.name;
      const currentClass = classCell.dataset.class;

      if (btn.innerText === 'ç¼–è¾‘') {
        nameCell.innerHTML = `<input type="text" value="${currentName}" class="edit-input">`;
        classCell.innerHTML = `<input type="text" value="${currentClass}" class="edit-input">`;
        btn.innerText = 'ä¿å­˜';
        btn.className = 'btn-edit';
      } else {
        const newName = nameCell.querySelector('input').value.trim();
        const newClass = classCell.querySelector('input').value.trim();

        if (!newName || !newClass) {
          alert('å§“åå’Œç­çº§ä¸èƒ½ä¸ºç©º');
          return;
        }

        updateStudent(studentId, newName, newClass)
          .then(() => {
            nameCell.innerHTML = newName;
            nameCell.dataset.name = newName;
            classCell.innerHTML = newClass;
            classCell.dataset.class = newClass;
            btn.innerText = 'ç¼–è¾‘';
            btn.className = 'btn-edit';
          })
          .catch(err => {
            alert('æ›´æ–°å¤±è´¥: ' + err.message);
            nameCell.innerHTML = currentName;
            nameCell.dataset.name = currentName;
            classCell.innerHTML = currentClass;
            classCell.dataset.class = currentClass;
            btn.innerText = 'ç¼–è¾‘';
            btn.className = 'btn-edit';
          });
      }
    }

    async function updateStudent(id, name, cls) {
      const res = await fetch(`${API_BASE}/teacher/update_student`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-User-ID': user.id
        },
        body: JSON.stringify({ id, name, class: cls })
      });
      const data = await res.json();
      if (!data.success) throw new Error(data.message);
    }

    async function deleteStudent(id) {
      if (!confirm(`ç¡®å®šåˆ é™¤å­¦ç”Ÿ ${id}ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;

      try {
        const res = await fetch(`${API_BASE}/teacher/delete_student`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-User-ID': user.id
          },
          body: JSON.stringify({ student_id: id })
        });
        const data = await res.json();
        if (data.success) {
          document.querySelector(`tr[data-id="${id}"]`).remove();
        } else {
          alert('åˆ é™¤å¤±è´¥: ' + data.message);
        }
      } catch (err) {
        console.error('åˆ é™¤å¤±è´¥:', err);
        alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
      }
    }

    // åˆå§‹åŒ–
    loadCourses();
    loadTimePeriod(); // åŠ è½½æ—¶é—´æ®µè®¾ç½®
  </script>
</body>
</html>
